# ETHcali Smart Contracts

Complete smart contract suite for ETHcali: identity verification, faucet distribution, and merchandise marketplace on Base, Ethereum, and Unichain.

**Repository**: [ETHcali/faucet-ethcali](https://github.com/ETHcali/faucet-ethcali)

## Overview

This repository contains three interconnected smart contract systems designed for the ETHcali ecosystem:

### 1. ZKPassportNFT - Identity Verification
Soulbound ERC721 NFT representing verified identity using ZKPassport technology (face match + personhood verification). Each user can self-verify and mint their non-transferable identity token.

### 2. FaucetVault - One-Time ETH Distribution
Automated ETH faucet that distributes funds to verified ZKPassportNFT holders. Each verified user receives a one-time claim of ETH to get started on the network.

### 3. Swag1155 - Merchandise Marketplace
ERC-1155 marketplace for ETHcali merchandise with USDC payments. Admins create products with multiple variants (sizes/colors), users purchase with USDC, and NFTs are minted with IPFS metadata representing physical merchandise claims.

## Contracts

### Contract Addresses

Addresses are generated by Hardhat Ignition and exported via the setup script. Run the setup to produce multi-network addresses and ABIs for your frontend:

\`\`\`bash
npx hardhat run scripts/setup-frontend.ts
\`\`\`

Then use the generated files in \`frontend/\` (contracts.json, addresses.json, contracts.ts, abis/).

### ZKPassportNFT (Soulbound Identity)

- **Standard**: ERC721 with transfer restrictions
- **Purpose**: Privacy-preserving identity verification
- **Features**:
  - Self-service minting with ZKPassport verification
  - On-chain SVG metadata with verification traits
  - One NFT per unique identifier + one per address
  - Non-transferable (soulbound)
- **Use Cases**: Gate access, prevent duplicate claims, verify humanity

### FaucetVault (ETH Distribution)

- **Purpose**: One-time ETH distribution to verified users
- **Features**:
  - Requires ZKPassportNFT ownership to claim
  - Configurable claim amount (default: 0.0001 ETH)
  - Prevents duplicate claims
  - Owner-controlled deposits and withdrawals
  - Pausable for emergency situations
- **Use Cases**: Onboarding users, covering gas fees, incentivizing participation

### Swag1155 (Merchandise Marketplace)

- **Standard**: ERC-1155 with per-token metadata URIs
- **Purpose**: ETHcali merchandise sales with USDC payments
- **Admin Features**:
  - Upload image → pin to IPFS
  - Set price, total supply, traits (gender, color, style)
  - Select sizes (S, M, L, XL)
  - Supply auto-splits per size (e.g., 20 total → 5 per size)
  - Frontend pins metadata per size → calls \`setVariantWithURI()\`
- **User Features**:
  - Select size (color) → quantity
  - Approve USDC → \`buy(tokenId, quantity)\`
  - NFT minted instantly with IPFS metadata
  - Treasury receives payment automatically
- **Use Cases**: Merchandise sales, event tickets, digital collectibles with physical redemption

**Frontend integration guide**: See [SWAG1155_FRONTEND.md](SWAG1155_FRONTEND.md) for complete admin & user flows, code examples, and React components.

## Features

- ✅ **Identity Verification**: Privacy-preserving ZKPassport integration with soulbound NFTs
- ✅ **Automated Faucet**: One-time ETH distribution to verified users
- ✅ **Merchandise Marketplace**: USDC-based sales with IPFS metadata
- ✅ **Multi-chain Support**: Deploy to Base, Ethereum, and Unichain
- ✅ **Production Ready**: Fully tested, verified, and documented

## Quick Start

### Installation

\`\`\`bash
npm install
\`\`\`

### Configuration

Create a \`.env\` file:

\`\`\`bash
PRIVATE_KEY=your_deployer_private_key  # Needs ETH to deploy/manage contracts

# Contract Configuration
ADMIN_ADDRESS=0x...  # Admin for Swag1155
TREASURY_ADDRESS=0x...  # Treasury for Swag1155 payments
SWAG1155_BASE_URI=https://your-ipfs-gateway.com/ipfs/

# USDC Addresses (network-specific for Swag1155)
USDC_ADDRESS_BASE=0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913
USDC_ADDRESS_ETH=0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48
USDC_ADDRESS_UNI=0x078D782b760474a361dDA0AF3839290b0EF57AD6
USDC_ADDRESS_OP=0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85

# RPC URLs
BASE_RPC_URL=https://base-mainnet.infura.io/v3/your_key
ETHEREUM_RPC_URL=https://mainnet.infura.io/v3/your_key
UNICHAIN_RPC_URL=https://unichain-mainnet.infura.io/v3/your_key

# Block Explorer API Keys (for contract verification)
ETHERSCAN_API_KEY=your_key
BASESCAN_API_KEY=your_key
UNICHAIN_API_KEY=your_key
\`\`\`

### Compile Contracts

\`\`\`bash
npm run compile
\`\`\`

### Run Tests

\`\`\`bash
npm test
\`\`\`

All 41 tests should pass covering:
- ZKPassportNFT: Minting, duplicate prevention, soulbound transfers
- FaucetVault: Claims, deposits, withdrawals, pausing
- Swag1155: Product variants, purchases, supply management
- Integration: Full flow verification

### Deploy (Hardhat v3 Ignition)

Deploy all contracts (ZKPassportNFT, FaucetVault, Swag1155) at once:

\`\`\`bash
# Clean deploy to Base Mainnet
rm -rf ignition/deployments/chain-8453
npm run deploy:base

# Clean deploy to Ethereum Mainnet
rm -rf ignition/deployments/chain-1
npm run deploy:ethereum

# Clean deploy to Unichain Mainnet
rm -rf ignition/deployments/chain-130
npm run deploy:unichain
\`\`\`

**Note**: Always delete the deployment directory before deploying to avoid resuming old deployments.

### Setup Frontend Files

Generate ABIs and addresses for frontend integration (run after each deployment):

\`\`\`bash
npm run setup:frontend
\`\`\`

This reads Ignition deployments and creates a \`frontend/\` directory with:
- \`contracts.json\` - Multi-network config with all deployed networks
- \`addresses.json\` - All network addresses in one file
- \`contracts.ts\` - TypeScript exports with multi-network helpers
- \`abis/\` - Shared ABIs (same for all networks)
- \`base/\` - Base Mainnet specific files
- \`unichain/\` - Unichain Mainnet specific files
- \`ethereum/\` - Ethereum Mainnet specific files

See \`frontend/README.md\` for detailed usage examples.

### Verify Contracts

Verify all contracts on block explorers (run after setup-frontend):

\`\`\`bash
# Verify on Base (Basescan + Sourcify)
npm run verify:base

# Verify on Ethereum (Etherscan + Sourcify)
npm run verify:ethereum

# Verify on Unichain (Uniscan + Sourcify)
npm run verify:unichain
\`\`\`

**Verifies automatically:**
- ✅ ZKPassportNFT with constructor args: \`["ZKPassport", "ZKP"]\`
- ✅ FaucetVault with constructor args: \`[nftAddress, "100000000000000"]\`
- ✅ Swag1155 with constructor args: \`[baseURI, usdcAddress, treasuryAddress]\`

**Requirements:**
- Run \`setup-frontend\` first to generate addresses
- Set \`BASESCAN_API_KEY\`, \`ETHERSCAN_API_KEY\` in \`.env\`
- Verifies on multiple explorers: Etherscan/Basescan/Uniscan + Sourcify

## Architecture

### System Flow

**Identity & Faucet:**
1. User verifies identity via ZKPassport SDK (face match + personhood)
2. Frontend receives verification data
3. User mints ZKPassportNFT via \`selfVerifyAndMint(uniqueIdentifier)\`
4. User claims ETH from FaucetVault (one-time, requires NFT ownership)

**Merchandise:**
1. Admin creates product with images, prices, and variants (sizes/colors)
2. Frontend pins metadata to IPFS per variant
3. Admin calls \`setVariantWithURI(tokenId, price, supply, uri)\`
4. Users browse products, approve USDC, and call \`buy(tokenId, quantity)\`
5. NFTs minted instantly, USDC transferred to treasury

## Technical Details

### ZKPassportNFT

- **Standard**: ERC721 with soulbound restrictions
- **Metadata**: On-chain Base64 JSON with dynamic SVG
- **Traits**: Face Match status, Personhood verification
- **Limits**: One NFT per uniqueIdentifier, one per address
- **Security**: Input validation, duplicate prevention, pausable

**Duplicate Prevention:**
- Each ZKPassport \`uniqueIdentifier\` can only mint once
- Each address can only hold one NFT
- Transfers disabled (soulbound)

### FaucetVault

- **Purpose**: Distributes ETH to verified users
- **Claim**: One-time claim per NFT holder
- **Amount**: Configurable by admin (default: 0.0001 ETH)
- **Security**: Pausable, reentrancy-protected
- **Access Control**: Owner can deposit, withdraw, update settings

### Swag1155

- **Standard**: ERC-1155 Multi-Token
- **Payment**: USDC ERC-20 token
- **Supply Management**: Per-variant supply tracking and enforcement
- **Metadata**: Per-token URI support (overrides base URI)
- **Admin Controls**: Set variants, activate/deactivate, update treasury
- **Security**: Reentrancy protection, supply validation, active status checks

## Network Support

- ✅ Base Mainnet (Chain ID: 8453)
- ✅ Ethereum Mainnet (Chain ID: 1)
- ✅ Unichain Mainnet (Chain ID: 130)

## Security

- ✅ Reentrancy guards on all external calls
- ✅ Access control (Ownable pattern)
- ✅ Input validation on all user inputs
- ✅ Pausable emergency controls
- ✅ Supply enforcement and bounds checking
- ✅ Comprehensive test coverage (41 tests passing)

## NPM Scripts

\`\`\`bash
npm run compile           # Compile contracts
npm test                  # Run all tests
npm run deploy:base       # Deploy to Base
npm run deploy:ethereum   # Deploy to Ethereum
npm run deploy:unichain   # Deploy to Unichain
npm run setup:frontend    # Generate frontend files
npm run verify:base       # Verify on Base
npm run verify:ethereum   # Verify on Ethereum
npm run verify:unichain   # Verify on Unichain
\`\`\`

## Repository

- **GitHub**: [ETHcali/faucet-ethcali](https://github.com/ETHcali/faucet-ethcali)

## License

MIT
